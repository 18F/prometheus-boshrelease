#!/bin/bash
set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

export HOME=/var/vcap

tar xfv promdash/promdash-0.1.0.tar.gz
cd promdash
bundle_cmd=/var/vcap/packages/ruby-2.1.4/bin/bundle
rake_cmd=/var/vcap/packages/ruby-2.1.4/bin/rake
mysqlclient_dir=/var/vcap/packages/mysqlclient
libpq_dir=/var/vcap/packages/libpq

$bundle_cmd config build.mysql2 --with-mysql-dir=$mysqlclient_dir --with-mysql-include=$mysqlclient_dir/include/mysql
$bundle_cmd config build.pg --with-pg-lib=$libpq_dir/lib --with-pg-include=$libpq_dir/include

#FIXME: figure out how to handle the rake version issue
#$bundle_cmd install --deployment --local --without="development test migration"
rm -rf public/assets/*
#$bundle_cmd exec $rake_cmd assets:precomiple

cp -a . $BOSH_INSTALL_TARGET
