#!/bin/bash

set -eux

# Copy common utils
mkdir -p ${BOSH_INSTALL_TARGET}/common
cp -a ${BOSH_COMPILE_TARGET}/common/* ${BOSH_INSTALL_TARGET}/common

# Extract golang package
tar xzvf ${BOSH_COMPILE_TARGET}/golang/go1.7.3.linux-amd64.tar.gz

# Build kube_state_metrics_exporter package
export GOROOT=${BOSH_COMPILE_TARGET}/go
export PATH=${GOROOT}/bin:${PATH}

PACKAGE_NAME=github.com/kubernetes/kube-state-metrics
mkdir -p ${BOSH_INSTALL_TARGET}/src/${PACKAGE_NAME}
cp -a ${BOSH_COMPILE_TARGET}/${PACKAGE_NAME}/* ${BOSH_INSTALL_TARGET}/src/${PACKAGE_NAME}
export GOPATH=${BOSH_INSTALL_TARGET}

go install ${PACKAGE_NAME}

rm -rf ${BOSH_INSTALL_TARGET}/pkg ${BOSH_INSTALL_TARGET}/src
